<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Calculadora</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
        }

        /* Theme variables */
        :root {
            /* iPhone theme (default) */
            --bg-color: #000;
            --display-color: #fff;
            --btn-gray-bg: #a5a5a5;
            --btn-gray-text: #000;
            --btn-orange-bg: #ff9f0a;
            --btn-orange-text: #fff;
            --btn-dark-bg: #333333;
            --btn-dark-text: #fff;
        }

        /* Android Light theme */
        body.android-light {
            --bg-color: #f1f3f4;
            --display-color: #202124;
            --btn-gray-bg: #dadce0;
            --btn-gray-text: #202124;
            --btn-orange-bg: #1a73e8;
            --btn-orange-text: #fff;
            --btn-dark-bg: #fff;
            --btn-dark-text: #202124;
        }

        /* Android Dark theme */
        body.android-dark {
            --bg-color: #202124;
            --display-color: #fff;
            --btn-gray-bg: #5f6368;
            --btn-gray-text: #fff;
            --btn-orange-bg: #8ab4f8;
            --btn-orange-text: #202124;
            --btn-dark-bg: #3c4043;
            --btn-dark-text: #fff;
        }

        /* S.A. theme (Samsung/Android style - with C button) */
        body.sa {
            --bg-color: #000;
            --display-color: #e0d5c7;
            --btn-gray-bg: #2a2a2a;
            --btn-gray-text: #e0d5c7;
            --btn-orange-bg: #8a9277;
            --btn-orange-text: #000;
            --btn-dark-bg: #1f1f1f;
            --btn-dark-text: #e0d5c7;
        }

        /* S.A. mode typography - Samsung style */
        body.sa .display-text {
            font-family: 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            font-weight: 300;
            letter-spacing: -0.01em;
        }

        body.sa .btn {
            font-family: 'Roboto', 'Helvetica Neue', Arial, sans-serif;
        }

        body.sa .btn-gray {
            font-weight: 400;
            font-size: 34px;
        }

        body.sa .btn-dark {
            font-weight: 300;
            font-size: 38px;
        }

        body.sa .btn-orange {
            font-weight: 400;
            font-size: 42px;
        }

        body.sa .btn-zero {
            font-size: 38px;
        }

        body.sa .buttons {
            gap: 12px;
            padding: 12px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: var(--bg-color);
            margin: 0;
            padding: 0;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            position: fixed;
        }

        .calculator {
            width: 100vw;
            height: 100vh;
            background: var(--bg-color);
            display: flex;
            flex-direction: column;
            padding: 0;
        }

        .display {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            justify-content: flex-end;
            padding: 20px 24px 16px 24px;
            overflow: visible;
        }

        .display-text {
            color: var(--display-color);
            font-size: 96px;
            font-weight: 200;
            text-align: right;
            line-height: 1.1;
            letter-spacing: -0.02em;
            white-space: nowrap;
            max-width: 100%;
            transition: font-size 0.1s ease;
        }

        .buttons {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            padding: 10px 10px 20px 10px;
        }

        .btn {
            aspect-ratio: 1;
            border-radius: 50%;
            border: none;
            font-size: 42px;
            font-weight: 400;
            cursor: pointer;
            transition: opacity 0.1s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }

        .btn:active {
            opacity: 0.4;
        }

        .btn-gray {
            background: var(--btn-gray-bg);
            color: var(--btn-gray-text);
            font-size: 38px;
            font-weight: 500;
        }

        /* S.A. mode: First gray button (C) should be red */
        body.sa .btn-gray:first-of-type {
            color: #f44336;
        }

        .btn-orange {
            background: var(--btn-orange-bg);
            color: var(--btn-orange-text);
            font-size: 46px;
            font-weight: 400;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            margin: 0;
            line-height: 0;
        }
        
        .btn-orange span {
            transform: translateY(-2px);
        }

        .btn-orange.active {
            background: var(--btn-orange-text);
            color: var(--btn-orange-bg);
        }

        .btn-dark {
            background: var(--btn-dark-bg);
            color: var(--btn-dark-text);
            font-size: 42px;
            font-weight: 400;
        }

        .btn-zero {
            grid-column: span 2;
            border-radius: 50px;
            justify-content: flex-start;
            padding-left: 30px;
            aspect-ratio: auto;
        }

        /* Secret menu overlay */
        .secret-menu {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .secret-menu.active {
            display: flex;
        }

        .menu-container {
            background: #1c1c1e;
            border-radius: 20px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            max-height: 85vh;
            display: flex;
            flex-direction: column;
        }

        .menu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 20px;
            margin-bottom: 20px;
            border-bottom: 1px solid #333;
            flex-shrink: 0;
        }

        .menu-title {
            color: #fff;
            font-size: 24px;
            font-weight: 600;
        }

        .close-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: #333;
            color: #fff;
            border: none;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .menu-content {
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
            overflow-x: hidden;
            padding-right: 5px;
        }

        .menu-content::-webkit-scrollbar {
            width: 6px;
        }

        .menu-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .menu-content::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 3px;
        }

        .mode-button {
            padding: 20px;
            border-radius: 16px;
            background: #1c1c1e;
            color: #fff;
            border: 2px solid transparent;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .mode-button.selected {
            border-color: #ff9f0a;
            background: #2c2c2e;
        }

        .checkmark {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            border: 2px solid #666;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .mode-button.selected .checkmark {
            background: #ff9f0a;
            border-color: #ff9f0a;
            color: #000;
        }

        .custom-input-container {
            display: none;
            padding: 20px;
            border-radius: 16px;
            background: #1c1c1e;
            margin-top: 10px;
        }

        .custom-input-container.active {
            display: block;
        }

        .custom-input {
            width: 100%;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #333;
            background: #000;
            color: #fff;
            font-size: 18px;
            text-align: center;
        }

        .input-label {
            color: #999;
            font-size: 14px;
            margin-bottom: 10px;
            text-align: center;
        }

        .time-buttons {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .time-btn {
            padding: 8px 12px;
            border-radius: 8px;
            background: #2c2c2e;
            color: #fff;
            border: 2px solid #444;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            flex: 1;
            min-width: 60px;
            text-align: center;
        }

        .time-btn.selected {
            background: #ff9f0a;
            border-color: #ff9f0a;
            color: #000;
            font-weight: 600;
        }

        /* Theme selector styles */
        .theme-selector {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #333;
        }

        .theme-btn {
            flex: 1;
            padding: 10px;
            border-radius: 8px;
            background: #2c2c2e;
            color: #fff;
            border: 2px solid #444;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .theme-btn.selected {
            border-color: #ff9f0a;
            background: #3c3c3e;
        }

        /* Spectator+ mode styles */
        .submode-buttons {
            display: flex;
            gap: 10px;
            margin-top: 12px;
        }

        .submode-btn {
            flex: 1;
            padding: 15px;
            border-radius: 12px;
            background: #2c2c2e;
            color: #fff;
            border: 2px solid #444;
            font-size: 16px;
            cursor: pointer;
        }

        .submode-btn.selected {
            border-color: #ff9f0a;
            background: #3c3c3e;
        }

        .format-buttons {
            display: flex;
            gap: 10px;
            margin-top: 12px;
            align-items: center;
        }

        .format-btn {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            background: #2c2c2e;
            color: #fff;
            border: 2px solid #444;
            font-size: 15px;
            cursor: pointer;
        }

        .format-btn.selected {
            background: #ff9f0a;
            border-color: #ff9f0a;
            color: #000;
            font-weight: 600;
        }

        .settings-btn {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: #2c2c2e;
            color: #fff;
            border: 2px solid #444;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Name popup */
        .name-popup {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .name-popup.active {
            display: flex;
        }

        .name-popup-content {
            background: #1c1c1e;
            border-radius: 20px;
            padding: 30px;
            min-width: 320px;
        }

        .name-popup-title {
            color: #fff;
            font-size: 20px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 20px;
        }

        .name-input {
            width: 100%;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #333;
            background: #000;
            color: #fff;
            font-size: 18px;
            text-align: center;
            margin-bottom: 20px;
        }

        .ok-btn {
            width: 100%;
            padding: 15px;
            border-radius: 10px;
            background: #ff9f0a;
            color: #000;
            border: none;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
        }

        /* Info popup */
        .info-popup {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .info-popup.active {
            display: flex;
        }

        .info-popup-content {
            background: #1c1c1e;
            border-radius: 20px;
            padding: 30px;
            min-width: 320px;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .info-popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .info-content {
            background: #2c2c2e;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            color: #fff;
            line-height: 1.6;
        }

        .info-list {
            list-style: none;
            padding: 0;
        }

        .info-list li {
            padding: 8px 0;
            border-bottom: 1px solid #444;
        }

        .info-list li:last-child {
            border-bottom: none;
        }

        .info-label {
            color: #999;
            font-size: 14px;
        }

        .info-value {
            color: #fff;
            font-size: 16px;
            font-weight: 500;
        }

        .copy-btn {
            width: 100%;
            padding: 15px;
            border-radius: 10px;
            background: #ff9f0a;
            color: #000;
            border: none;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 10px;
        }

        .fav-number-display {
            text-align: center;
            color: #999;
            font-size: 14px;
            margin-top: 10px;
        }

        /* Template editor popup */
        .template-popup {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .template-popup.active {
            display: flex;
        }

        .template-popup-content {
            background: #1c1c1e;
            border-radius: 20px;
            padding: 30px;
            min-width: 320px;
            max-width: 500px;
        }

        .template-textarea {
            width: 100%;
            min-height: 150px;
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #333;
            background: #000;
            color: #fff;
            font-size: 16px;
            resize: vertical;
            margin-bottom: 20px;
            font-family: inherit;
        }

    </style>
</head>
<body>
    <div class="calculator">
        <div class="display">
            <div class="display-text" id="display">0</div>
        </div>
        <div class="buttons">
            <button class="btn btn-gray" id="ac-button" onclick="clearAll()">AC</button>
            <button class="btn btn-gray" onclick="toggleSign()">+/-</button>
            <button class="btn btn-gray" onclick="openSecretMenu()">%</button>
            <button class="btn btn-orange" onclick="setOperation('÷')"><span>÷</span></button>
            
            <button class="btn btn-dark" onclick="appendNumber('7')">7</button>
            <button class="btn btn-dark" onclick="appendNumber('8')">8</button>
            <button class="btn btn-dark" onclick="appendNumber('9')">9</button>
            <button class="btn btn-orange" onclick="setOperation('×')"><span>×</span></button>
            
            <button class="btn btn-dark" onclick="appendNumber('4')">4</button>
            <button class="btn btn-dark" onclick="appendNumber('5')">5</button>
            <button class="btn btn-dark" onclick="appendNumber('6')">6</button>
            <button class="btn btn-orange" onclick="setOperation('-')"><span>−</span></button>
            
            <button class="btn btn-dark" onclick="appendNumber('1')">1</button>
            <button class="btn btn-dark" onclick="appendNumber('2')">2</button>
            <button class="btn btn-dark" onclick="appendNumber('3')">3</button>
            <button class="btn btn-orange" onclick="setOperation('+')"><span>+</span></button>
            
            <button class="btn btn-dark btn-zero" onclick="appendNumber('0')">0</button>
            <button class="btn btn-dark" onclick="appendDecimal()">,</button>
            <button class="btn btn-orange" id="equals-btn" onclick="calculate()" ontouchstart="startEqualsLongPress(event)" ontouchend="endEqualsLongPress()" onmousedown="startEqualsLongPress(event)" onmouseup="endEqualsLongPress()"><span>=</span></button>
        </div>
    </div>

    <!-- Secret Menu -->
    <div class="secret-menu" id="secret-menu">
        <div class="menu-container">
            <div class="menu-header">
                <div class="menu-title">Modo Mágico</div>
                <button class="close-btn" onclick="closeSecretMenu()">✕</button>
            </div>
            <div class="menu-content">
                <!-- Theme Selector -->
                <div class="theme-selector">
                    <button class="theme-btn selected" id="theme-iphone-btn" onclick="selectTheme('iphone')">iPhone</button>
                    <button class="theme-btn" id="theme-sa-btn" onclick="selectTheme('sa')">S.A.</button>
                    <button class="theme-btn" id="theme-android-light-btn" onclick="selectTheme('android-light')">Android Claro</button>
                    <button class="theme-btn" id="theme-android-dark-btn" onclick="selectTheme('android-dark')">Android Oscuro</button>
                </div>
                
                <button class="mode-button selected" id="date-mode-btn" onclick="selectMode('date')">
                    <span>Modo Fecha</span>
                    <span class="checkmark">✓</span>
                </button>
                <div class="time-buttons" id="date-time-buttons">
                    <button class="time-btn selected" onclick="selectTimeThreshold(10)">10s</button>
                    <button class="time-btn" onclick="selectTimeThreshold(15)">15s</button>
                    <button class="time-btn" onclick="selectTimeThreshold(20)">20s</button>
                    <button class="time-btn" onclick="selectTimeThreshold('10-15')">10-15s</button>
                    <button class="time-btn" onclick="selectTimeThreshold('10-20')">10-20s</button>
                </div>
                
                <button class="mode-button" id="custom-mode-btn" onclick="selectMode('custom')">
                    <span>Personalizado</span>
                    <span class="checkmark"></span>
                </button>
                <div class="time-buttons" id="custom-time-buttons" style="display: none;">
                    <button class="time-btn selected" onclick="selectTimeThreshold(10)">10s</button>
                    <button class="time-btn" onclick="selectTimeThreshold(15)">15s</button>
                    <button class="time-btn" onclick="selectTimeThreshold(20)">20s</button>
                    <button class="time-btn" onclick="selectTimeThreshold('10-15')">10-15s</button>
                    <button class="time-btn" onclick="selectTimeThreshold('10-20')">10-20s</button>
                </div>
                
                <div class="custom-input-container" id="custom-input-container">
                    <div class="input-label">Introduce el número final deseado:</div>
                    <input type="text" class="custom-input" id="custom-result" placeholder="Ej: 123456789" maxlength="16">
                </div>
                
                <!-- Spectator+ Mode -->
                <button class="mode-button" id="spectator-mode-btn" onclick="selectMode('spectator')">
                    <span>Espectador+</span>
                    <span class="checkmark"></span>
                </button>
                <div id="spectator-options" style="display: none;">
                    <!-- Submode buttons -->
                    <div class="submode-buttons">
                        <button class="submode-btn selected" id="spectator-date-btn" onclick="selectSpectatorSubmode('date')">Hora</button>
                        <button class="submode-btn" id="spectator-custom-btn" onclick="selectSpectatorSubmode('custom')">Personalizado</button>
                    </div>
                    
                    <!-- Format buttons -->
                    <div class="format-buttons">
                        <button class="format-btn selected" id="format-list-btn" onclick="selectFormat('list')">Lista</button>
                        <button class="format-btn" id="format-text-btn" onclick="selectFormat('text')">Texto</button>
                        <button class="settings-btn" id="template-settings-btn" onclick="openTemplateEditor()" style="display: none;">⚙</button>
                    </div>
                    
                    <!-- Time buttons for date submode -->
                    <div class="time-buttons" id="spectator-date-time-buttons">
                        <button class="time-btn selected" onclick="selectTimeThreshold(10)">10s</button>
                        <button class="time-btn" onclick="selectTimeThreshold(15)">15s</button>
                        <button class="time-btn" onclick="selectTimeThreshold(20)">20s</button>
                        <button class="time-btn" onclick="selectTimeThreshold('10-15')">10-15s</button>
                        <button class="time-btn" onclick="selectTimeThreshold('10-20')">10-20s</button>
                    </div>
                    
                    <!-- Options for custom submode -->
                    <div id="spectator-custom-options" style="display: none;">
                        <div class="time-buttons">
                            <button class="time-btn selected" onclick="selectTimeThreshold(10)">10s</button>
                            <button class="time-btn" onclick="selectTimeThreshold(15)">15s</button>
                            <button class="time-btn" onclick="selectTimeThreshold(20)">20s</button>
                            <button class="time-btn" onclick="selectTimeThreshold('10-15')">10-15s</button>
                            <button class="time-btn" onclick="selectTimeThreshold('10-20')">10-20s</button>
                        </div>
                        <div class="custom-input-container active">
                            <div class="input-label">Introduce el número final deseado:</div>
                            <input type="text" class="custom-input" id="spectator-custom-result" placeholder="Ej: 123456789" maxlength="16">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Name Popup -->
    <div class="name-popup" id="name-popup">
        <div class="name-popup-content">
            <div class="name-popup-title">Nombre del espectador</div>
            <input type="text" class="name-input" id="spectator-name" placeholder="Escribe el nombre...">
            <button class="ok-btn" onclick="confirmName()">OK</button>
        </div>
    </div>

    <!-- Info Popup -->
    <div class="info-popup" id="info-popup">
        <div class="info-popup-content">
            <div class="info-popup-header">
                <div class="menu-title">Información</div>
                <button class="close-btn" onclick="closeInfoPopup()">✕</button>
            </div>
            <div class="info-content" id="info-content"></div>
            <button class="copy-btn" onclick="copyInfo()">Copiar</button>
            <div class="fav-number-display" id="fav-number-display" style="display: none;"></div>
        </div>
    </div>

    <!-- Template Editor Popup -->
    <div class="template-popup" id="template-popup">
        <div class="template-popup-content">
            <div class="menu-header">
                <div class="menu-title">Editar Template</div>
                <button class="close-btn" onclick="closeTemplateEditor()">✕</button>
            </div>
            <textarea class="template-textarea" id="template-text"></textarea>
            <button class="ok-btn" onclick="saveTemplate()">Guardar</button>
        </div>
    </div>

    <script>
        let display = document.getElementById('display');
        let currentValue = '0';
        let previousValue = null;
        let operation = null;
        let shouldResetDisplay = false;
        let multiplicationCount = 0;
        let magicTriggered = false;
        let waitingForMagicTrigger = false;
        let screenLocked = false;
        
        // Mode management
        let magicMode = 'date'; // 'date', 'custom', or 'spectator'
        let customResult = '';
        let timeThreshold = 10; // Default: 10 seconds
        
        // Long press for equals button
        let equalsLongPressTimer = null;
        let isEqualsLongPress = false;
        let customModeActivated = false;
        
        // Spectator+ mode variables
        let spectatorSubmode = 'date'; // 'date' or 'custom'
        let spectatorFormat = 'list'; // 'list' or 'text'
        let spectatorName = '';
        let spectatorNumbers = []; // [birthdate, favNumber, ...extras]
        let spectatorCustomResult = '';
        let textTemplate = 'Hoy haré un poco de magia para [Nombre]. Tiene [Edad] años y me da la sensación de que su signo zodiacal es [Signo zodiacal]. Cada pequeño detalle suyo ha sido parte de la ilusión que he creado.';
        
        // Theme variable
        let currentTheme = 'iphone'; // 'iphone', 'sa', 'android-light', or 'android-dark'

        function selectTheme(theme) {
            currentTheme = theme;
            
            // Remove all theme classes
            document.body.classList.remove('sa', 'android-light', 'android-dark');
            
            // Add theme class if not iPhone (iPhone is default/no class)
            if (theme === 'sa') {
                document.body.classList.add('sa');
                document.getElementById('ac-button').textContent = 'C';
            } else if (theme === 'android-light') {
                document.body.classList.add('android-light');
                document.getElementById('ac-button').textContent = 'AC';
            } else if (theme === 'android-dark') {
                document.body.classList.add('android-dark');
                document.getElementById('ac-button').textContent = 'AC';
            } else {
                // iPhone
                document.getElementById('ac-button').textContent = 'AC';
            }
            
            // Update button states
            document.getElementById('theme-iphone-btn').classList.remove('selected');
            document.getElementById('theme-sa-btn').classList.remove('selected');
            document.getElementById('theme-android-light-btn').classList.remove('selected');
            document.getElementById('theme-android-dark-btn').classList.remove('selected');
            
            document.getElementById(`theme-${theme}-btn`).classList.add('selected');
        }

        function updateDisplay() {
            let displayValue = currentValue;
            
            // Adjust font size based on length - more aggressive scaling
            let fontSize;
            if (displayValue.length <= 6) {
                fontSize = '96px';
            } else if (displayValue.length === 7) {
                fontSize = '82px';
            } else if (displayValue.length === 8) {
                fontSize = '72px';
            } else if (displayValue.length === 9) {
                fontSize = '64px';
            } else if (displayValue.length === 10) {
                fontSize = '58px';
            } else if (displayValue.length === 11) {
                fontSize = '52px';
            } else if (displayValue.length === 12) {
                fontSize = '48px';
            } else if (displayValue.length === 13) {
                fontSize = '44px';
            } else {
                fontSize = '40px';
            }
            
            display.style.fontSize = fontSize;
            display.textContent = displayValue.replace('.', ',');
        }

        function appendNumber(num) {
            // Check if we're waiting for magic trigger
            if (waitingForMagicTrigger) {
                triggerMagic();
                return;
            }

            if (screenLocked) return;

            if (shouldResetDisplay) {
                currentValue = num;
                shouldResetDisplay = false;
            } else {
                if (currentValue === '0') {
                    currentValue = num;
                } else {
                    currentValue += num;
                }
            }
            updateDisplay();
        }

        function appendDecimal() {
            if (waitingForMagicTrigger) {
                triggerMagic();
                return;
            }

            if (screenLocked) return;
            
            if (shouldResetDisplay) {
                currentValue = '0';
                shouldResetDisplay = false;
            }
            
            if (!currentValue.includes('.')) {
                currentValue += '.';
            }
            updateDisplay();
        }

        function clearAll() {
            // In Spectator+ mode after magic, show info popup
            if (magicMode === 'spectator' && magicTriggered) {
                const infoContent = generateInfoContent();
                document.getElementById('info-content').innerHTML = infoContent;
                document.getElementById('info-popup').classList.add('active');
                return;
            }
            
            // In Spectator+ mode without name, show name popup
            if (magicMode === 'spectator' && !spectatorName) {
                document.getElementById('name-popup').classList.add('active');
                return;
            }
            
            currentValue = '0';
            previousValue = null;
            operation = null;
            shouldResetDisplay = false;
            multiplicationCount = 0;
            magicTriggered = false;
            waitingForMagicTrigger = false;
            screenLocked = false;
            customModeActivated = false;
            isEqualsLongPress = false;
            spectatorNumbers = [];
            clearTimeout(equalsLongPressTimer);
            document.querySelectorAll('.btn-orange').forEach(btn => btn.classList.remove('active'));
            updateDisplay();
        }

        function toggleSign() {
            if (waitingForMagicTrigger) {
                triggerMagic();
                return;
            }

            if (screenLocked) return;
            
            if (currentValue !== '0') {
                currentValue = currentValue.startsWith('-') 
                    ? currentValue.substring(1) 
                    : '-' + currentValue;
                updateDisplay();
            }
        }

        function setOperation(op) {
            if (waitingForMagicTrigger) {
                triggerMagic();
                return;
            }

            if (screenLocked) return;

            // DATE MODE: Check if we should activate magic (any multiplications + plus)
            if (magicMode === 'date' && op === '+' && multiplicationCount >= 1 && !magicTriggered) {
                waitingForMagicTrigger = true;
                
                // Save current result and operation
                previousValue = currentValue;
                operation = '+';
                shouldResetDisplay = true;
                
                // Highlight + button
                document.querySelectorAll('.btn-orange').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
                return;
            }

            // CUSTOM MODE: Check if + is pressed after long press on =
            if (magicMode === 'custom' && op === '+' && customModeActivated && !magicTriggered) {
                waitingForMagicTrigger = true;
                
                // Save current result and operation
                previousValue = currentValue;
                operation = '+';
                shouldResetDisplay = true;
                
                // Highlight + button
                document.querySelectorAll('.btn-orange').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
                return;
            }

            // SPECTATOR+ MODE
            if (magicMode === 'spectator' && op === '+' && !magicTriggered) {
                if (spectatorSubmode === 'date' && multiplicationCount >= 1) {
                    waitingForMagicTrigger = true;
                    previousValue = currentValue;
                    operation = '+';
                    shouldResetDisplay = true;
                    document.querySelectorAll('.btn-orange').forEach(btn => btn.classList.remove('active'));
                    event.target.classList.add('active');
                    return;
                } else if (spectatorSubmode === 'custom' && customModeActivated) {
                    waitingForMagicTrigger = true;
                    previousValue = currentValue;
                    operation = '+';
                    shouldResetDisplay = true;
                    document.querySelectorAll('.btn-orange').forEach(btn => btn.classList.remove('active'));
                    event.target.classList.add('active');
                    return;
                }
            }

            if (previousValue !== null && operation && !shouldResetDisplay) {
                // Don't calculate, just change operation
                operation = op;
            } else {
                previousValue = currentValue;
                operation = op;
                shouldResetDisplay = true;
            }
            
            // Update active state
            document.querySelectorAll('.btn-orange').forEach(btn => btn.classList.remove('active'));
            if (event && event.target) {
                event.target.classList.add('active');
            }
        }

        function calculate() {
            if (operation && previousValue !== null) {
                let prev = parseFloat(previousValue);
                let curr = parseFloat(currentValue);
                let result;

                switch (operation) {
                    case '+':
                        result = prev + curr;
                        break;
                    case '-':
                        result = prev - curr;
                        break;
                    case '×':
                        result = prev * curr;
                        multiplicationCount++;
                        
                        // Capture numbers in Spectator+ mode
                        if (magicMode === 'spectator' && !magicTriggered) {
                            // First multiplication: capture both numbers (birthdate and fav number)
                            if (spectatorNumbers.length === 0) {
                                spectatorNumbers.push(prev); // Birthdate (first number)
                                spectatorNumbers.push(curr); // Favorite number (second number)
                            } else {
                                // Additional multiplications: just capture as extras
                                spectatorNumbers.push(curr);
                            }
                        }
                        break;
                    case '÷':
                        result = prev / curr;
                        break;
                }

                currentValue = result.toString();
                previousValue = currentValue;
                operation = null;
                shouldResetDisplay = true;
                
                document.querySelectorAll('.btn-orange').forEach(btn => btn.classList.remove('active'));
                updateDisplay();
            }
        }

        function triggerMagic() {
            magicTriggered = true;
            waitingForMagicTrigger = false;
            screenLocked = true;
            
            // Calculate magic number
            const magicNum = getMagicNumber();
            currentValue = magicNum;
            shouldResetDisplay = false;
            
            updateDisplay();
        }

        function getTargetDateTime() {
            const now = new Date();
            const seconds = now.getSeconds();
            
            // Determinar si debemos avanzar al siguiente minuto según el threshold seleccionado
            let shouldAdvanceMinute = false;
            
            if (typeof timeThreshold === 'number') {
                // Threshold fijo: 10s, 15s, 20s
                shouldAdvanceMinute = seconds >= (60 - timeThreshold);
            } else if (timeThreshold === '10-15') {
                // Si faltan entre 10-15 segundos (segundos entre 45-50)
                shouldAdvanceMinute = seconds >= 45 && seconds <= 50;
            } else if (timeThreshold === '10-20') {
                // Si faltan entre 10-20 segundos (segundos entre 40-50)
                shouldAdvanceMinute = seconds >= 40 && seconds <= 50;
            }
            
            if (shouldAdvanceMinute) {
                now.setMinutes(now.getMinutes() + 1);
            }
            
            const day = String(now.getDate()).padStart(2, '0');
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const year = String(now.getFullYear()).slice(-2); // Solo últimos 2 dígitos
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            
            return day + month + year + hours + minutes;
        }

        function getMagicNumber() {
            let target;
            
            if (magicMode === 'date') {
                target = getTargetDateTime();
            } else if (magicMode === 'custom') {
                target = customResult || '0';
            } else if (magicMode === 'spectator') {
                if (spectatorSubmode === 'date') {
                    target = getTargetDateTime();
                } else {
                    target = spectatorCustomResult || '0';
                }
            }
            
            const currentNum = parseFloat(previousValue);
            const targetNum = parseFloat(target);
            const difference = targetNum - currentNum;
            
            return difference.toString();
        }

        // Long press functions for = button (custom mode)
        function startEqualsLongPress(e) {
            e.preventDefault();
            isEqualsLongPress = false;
            
            // Only enable long press in custom mode
            if (magicMode === 'custom' && customResult) {
                equalsLongPressTimer = setTimeout(() => {
                    isEqualsLongPress = true;
                    customModeActivated = true;
                    // Visual feedback could be added here
                }, 2000); // 2 seconds
            }
        }

        function endEqualsLongPress() {
            clearTimeout(equalsLongPressTimer);
            
            // If it was a long press, don't execute normal click
            if (isEqualsLongPress) {
                isEqualsLongPress = false;
                return false; // Prevent normal click
            }
            
            isEqualsLongPress = false;
        }

        // Secret menu functions
        function openSecretMenu() {
            document.getElementById('secret-menu').classList.add('active');
        }

        function closeSecretMenu() {
            document.getElementById('secret-menu').classList.remove('active');
            
            // If Spectator+ mode, show name popup
            if (magicMode === 'spectator') {
                document.getElementById('name-popup').classList.add('active');
            }
        }

        function selectMode(mode) {
            magicMode = mode;
            
            // Remove all selected states
            document.getElementById('date-mode-btn').classList.remove('selected');
            document.getElementById('custom-mode-btn').classList.remove('selected');
            document.getElementById('spectator-mode-btn').classList.remove('selected');
            
            // Hide all options
            document.getElementById('date-time-buttons').style.display = 'none';
            document.getElementById('custom-time-buttons').style.display = 'none';
            document.getElementById('custom-input-container').classList.remove('active');
            document.getElementById('spectator-options').style.display = 'none';
            
            if (mode === 'date') {
                document.getElementById('date-mode-btn').classList.add('selected');
                document.getElementById('date-time-buttons').style.display = 'flex';
            } else if (mode === 'custom') {
                document.getElementById('custom-mode-btn').classList.add('selected');
                document.getElementById('custom-input-container').classList.add('active');
                document.getElementById('custom-time-buttons').style.display = 'flex';
            } else if (mode === 'spectator') {
                document.getElementById('spectator-mode-btn').classList.add('selected');
                document.getElementById('spectator-options').style.display = 'block';
                spectatorNumbers = []; // Reset
            }
        }

        function selectSpectatorSubmode(submode) {
            spectatorSubmode = submode;
            
            document.getElementById('spectator-date-btn').classList.remove('selected');
            document.getElementById('spectator-custom-btn').classList.remove('selected');
            
            if (submode === 'date') {
                document.getElementById('spectator-date-btn').classList.add('selected');
                document.getElementById('spectator-date-time-buttons').style.display = 'flex';
                document.getElementById('spectator-custom-options').style.display = 'none';
            } else {
                document.getElementById('spectator-custom-btn').classList.add('selected');
                document.getElementById('spectator-date-time-buttons').style.display = 'none';
                document.getElementById('spectator-custom-options').style.display = 'block';
            }
        }

        function selectFormat(format) {
            spectatorFormat = format;
            
            document.getElementById('format-list-btn').classList.remove('selected');
            document.getElementById('format-text-btn').classList.remove('selected');
            
            if (format === 'list') {
                document.getElementById('format-list-btn').classList.add('selected');
                document.getElementById('template-settings-btn').style.display = 'none';
            } else {
                document.getElementById('format-text-btn').classList.add('selected');
                document.getElementById('template-settings-btn').style.display = 'flex';
            }
        }

        function confirmName() {
            spectatorName = document.getElementById('spectator-name').value;
            document.getElementById('name-popup').classList.remove('active');
            spectatorNumbers = [];
        }

        function openTemplateEditor() {
            document.getElementById('template-text').value = textTemplate;
            document.getElementById('template-popup').classList.add('active');
        }

        function closeTemplateEditor() {
            document.getElementById('template-popup').classList.remove('active');
        }

        function saveTemplate() {
            textTemplate = document.getElementById('template-text').value;
            closeTemplateEditor();
        }

        function selectTimeThreshold(threshold) {
            timeThreshold = threshold;
            
            // Remove selected class from all time buttons in both groups
            document.querySelectorAll('.time-btn').forEach(btn => {
                btn.classList.remove('selected');
            });
            
            // Add selected class to clicked button
            event.target.classList.add('selected');
        }

        document.getElementById('custom-result').addEventListener('input', function(e) {
            customResult = e.target.value.replace(/\D/g, '');
            e.target.value = customResult;
        });

        document.getElementById('spectator-custom-result').addEventListener('input', function(e) {
            spectatorCustomResult = e.target.value.replace(/\D/g, '');
            e.target.value = spectatorCustomResult;
        });

        // Spectator+ helper functions
        function calculateAge(birthdate) {
            const bdStr = birthdate.toString().padStart(6, '0');
            const day = parseInt(bdStr.substring(0, 2));
            const month = parseInt(bdStr.substring(2, 4));
            let year = parseInt(bdStr.substring(4, 6));
            
            // Smart dynamic year detection that works forever:
            const currentYear = new Date().getFullYear();
            const currentYearShort = currentYear % 100; // Last 2 digits of current year
            
            // Try both interpretations
            const year2000s = 2000 + year;
            const year1900s = 1900 + year;
            
            // Calculate what the age would be in each case
            const age2000s = currentYear - year2000s;
            const age1900s = currentYear - year1900s;
            
            // Decision logic:
            // 1. If 2000s would make them not born yet (negative age), use 1900s
            // 2. If 1900s would make them over 110 years old (unrealistic), use 2000s
            // 3. Otherwise: if the year is <= current year's last 2 digits, assume 2000s
            //    Example in 2026: 00-26 = 2000s, 27-99 = 1900s
            //    Example in 2050: 00-50 = 2000s, 51-99 = 1900s
            
            if (age2000s < 0) {
                // Not born yet in 2000s interpretation, must be 1900s
                year = year1900s;
            } else if (age1900s > 110) {
                // Over 110 years old in 1900s interpretation, must be 2000s
                year = year2000s;
            } else {
                // Both valid - use current year as pivot
                year = year <= currentYearShort ? year2000s : year1900s;
            }
            
            const today = new Date();
            const birthDate = new Date(year, month - 1, day);
            
            let age = today.getFullYear() - birthDate.getFullYear();
            const monthDiff = today.getMonth() - birthDate.getMonth();
            
            if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
                age--;
            }
            
            return age;
        }

        function getZodiacSign(birthdate) {
            const bdStr = birthdate.toString().padStart(6, '0');
            const day = parseInt(bdStr.substring(0, 2));
            const month = parseInt(bdStr.substring(2, 4));
            
            // Zodiac signs with proper date ranges
            if ((month === 3 && day >= 21) || (month === 4 && day <= 19)) return 'Aries';
            if ((month === 4 && day >= 20) || (month === 5 && day <= 20)) return 'Tauro';
            if ((month === 5 && day >= 21) || (month === 6 && day <= 20)) return 'Géminis';
            if ((month === 6 && day >= 21) || (month === 7 && day <= 22)) return 'Cáncer';
            if ((month === 7 && day >= 23) || (month === 8 && day <= 22)) return 'Leo';
            if ((month === 8 && day >= 23) || (month === 9 && day <= 22)) return 'Virgo';
            if ((month === 9 && day >= 23) || (month === 10 && day <= 22)) return 'Libra';
            if ((month === 10 && day >= 23) || (month === 11 && day <= 21)) return 'Escorpio';
            if ((month === 11 && day >= 22) || (month === 12 && day <= 21)) return 'Sagitario';
            if ((month === 12 && day >= 22) || (month === 1 && day <= 19)) return 'Capricornio';
            if ((month === 1 && day >= 20) || (month === 2 && day <= 18)) return 'Acuario';
            if ((month === 2 && day >= 19) || (month === 3 && day <= 20)) return 'Piscis';
            
            return 'Desconocido';
        }

        function generateInfoContent() {
            if (spectatorNumbers.length < 2) {
                return '<p style="color: #999;">No hay suficiente información</p>';
            }
            
            const birthdate = spectatorNumbers[0];
            const favNumber = spectatorNumbers[1];
            const age = calculateAge(birthdate);
            const zodiac = getZodiacSign(birthdate);
            
            if (spectatorFormat === 'list') {
                return `
                    <ul class="info-list">
                        <li>
                            <div class="info-label">Nombre</div>
                            <div class="info-value">${spectatorName}</div>
                        </li>
                        <li>
                            <div class="info-label">Edad</div>
                            <div class="info-value">${age} años</div>
                        </li>
                        <li>
                            <div class="info-label">Signo Zodiacal</div>
                            <div class="info-value">${zodiac}</div>
                        </li>
                        <li>
                            <div class="info-label">Número Favorito</div>
                            <div class="info-value">${favNumber}</div>
                        </li>
                    </ul>
                `;
            } else {
                // Text format
                let text = textTemplate;
                text = text.replace(/\[Nombre\]/g, spectatorName);
                text = text.replace(/\[Edad\]/g, age.toString());
                text = text.replace(/\[Signo zodiacal\]/g, zodiac);
                
                // Show favorite number separately in text mode
                document.getElementById('fav-number-display').innerHTML = `Número favorito: ${favNumber}`;
                document.getElementById('fav-number-display').style.display = 'block';
                
                return `<p style="color: #fff; line-height: 1.8;">${text}</p>`;
            }
        }

        function closeInfoPopup() {
            document.getElementById('info-popup').classList.remove('active');
            document.getElementById('fav-number-display').style.display = 'none';
            
            // Reset everything
            currentValue = '0';
            previousValue = null;
            operation = null;
            shouldResetDisplay = false;
            multiplicationCount = 0;
            magicTriggered = false;
            waitingForMagicTrigger = false;
            screenLocked = false;
            customModeActivated = false;
            spectatorNumbers = [];
            spectatorName = ''; // Reset name so AC will prompt for name again
            
            document.querySelectorAll('.btn-orange').forEach(btn => btn.classList.remove('active'));
            updateDisplay();
        }

        function copyInfo() {
            let textToCopy = '';
            
            if (spectatorNumbers.length < 2) return;
            
            const birthdate = spectatorNumbers[0];
            const favNumber = spectatorNumbers[1];
            const age = calculateAge(birthdate);
            const zodiac = getZodiacSign(birthdate);
            
            if (spectatorFormat === 'list') {
                textToCopy = `Nombre: ${spectatorName}
Edad: ${age} años
Signo Zodiacal: ${zodiac}
Número Favorito: ${favNumber}`;
            } else {
                let text = textTemplate;
                text = text.replace(/\[Nombre\]/g, spectatorName);
                text = text.replace(/\[Edad\]/g, age.toString());
                text = text.replace(/\[Signo zodiacal\]/g, zodiac);
                textToCopy = text;
            }
            
            navigator.clipboard.writeText(textToCopy).then(() => {
                const btn = event.target;
                const originalText = btn.textContent;
                btn.textContent = '¡Copiado!';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 1500);
            });
        }

        // Initialize
        updateDisplay();
    </script>
</body>
</html>
